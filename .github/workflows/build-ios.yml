name: Build iOS IPA (Unsigned for LiveContainer)

on:
  push:
    branches: [ master, main, develop ]
  pull_request:
    branches: [ master, main, develop ]

concurrency:
  group: build-ios-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-ios:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Create Metadata File
      run: |
        mkdir -p build/output
        echo "PCSX2 iOS App - Built for LiveContainer" > build/output/BUILD_INFO.txt
        echo "========================================" >> build/output/BUILD_INFO.txt
        echo "" >> build/output/BUILD_INFO.txt
        echo "Bundle ID: com.anchdev.pcsx2" >> build/output/BUILD_INFO.txt
        echo "App Name: PCSX2" >> build/output/BUILD_INFO.txt
        echo "Version: 1.0 (Build 1)" >> build/output/BUILD_INFO.txt
        echo "Minimum iOS: 14.0" >> build/output/BUILD_INFO.txt
        echo "Architecture: arm64 (Apple Silicon)" >> build/output/BUILD_INFO.txt
        echo "" >> build/output/BUILD_INFO.txt
        echo "Build Instructions:" >> build/output/BUILD_INFO.txt
        echo "==================" >> build/output/BUILD_INFO.txt
        echo "Full IPA builds require macOS runner with Xcode." >> build/output/BUILD_INFO.txt
        echo "" >> build/output/BUILD_INFO.txt
        echo "To build locally on your Mac:" >> build/output/BUILD_INFO.txt
        echo "1. Clone: git clone https://github.com/anchdev/Anchsx2.git" >> build/output/BUILD_INFO.txt
        echo "2. cd Anchsx2" >> build/output/BUILD_INFO.txt
        echo "3. See docs/iOS_Build_Guide.md for full instructions" >> build/output/BUILD_INFO.txt
        echo "" >> build/output/BUILD_INFO.txt
        echo "Installation Instructions:" >> build/output/BUILD_INFO.txt
        echo "=========================" >> build/output/BUILD_INFO.txt
        echo "1. Build IPA locally on macOS" >> build/output/BUILD_INFO.txt
        echo "2. Download PCSX2-unsigned.ipa" >> build/output/BUILD_INFO.txt
        echo "3. Open in LiveContainer app" >> build/output/BUILD_INFO.txt
        echo "4. Install and run on iOS device" >> build/output/BUILD_INFO.txt
        echo "" >> build/output/BUILD_INFO.txt
        echo "Features:" >> build/output/BUILD_INFO.txt
        echo "- Metal GPU acceleration" >> build/output/BUILD_INFO.txt
        echo "- Modern SwiftUI interface" >> build/output/BUILD_INFO.txt
        echo "- File picker for ROM selection" >> build/output/BUILD_INFO.txt
        echo "- Playback controls (Play/Pause/Stop)" >> build/output/BUILD_INFO.txt
        echo "" >> build/output/BUILD_INFO.txt
        echo "Compatibility:" >> build/output/BUILD_INFO.txt
        echo "- iOS 14.0 or later" >> build/output/BUILD_INFO.txt
        echo "- iPhone and iPad" >> build/output/BUILD_INFO.txt
        echo "- All Apple Silicon devices recommended" >> build/output/BUILD_INFO.txt
        cat build/output/BUILD_INFO.txt

    - name: Upload Metadata Artifact
      uses: actions/upload-artifact@v4
      with:
        name: PCSX2-iOS-LiveContainer
        path: build/output/
        retention-days: 30

    - name: Create Release (on Tags)
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: build/output/BUILD_INFO.txt
        body: |
          PCSX2 iOS Build
          
          **For full IPA builds, see the [iOS Build Guide](https://github.com/anchdev/Anchsx2/blob/master/docs/iOS_Build_Guide.md)**
          
          Build locally on macOS:
          ```bash
          git clone https://github.com/anchdev/Anchsx2.git
          cd Anchsx2
          mkdir build && cd build
          cmake -G Xcode -DCMAKE_SYSTEM_NAME=iOS -DCMAKE_OSX_ARCHITECTURES=arm64 -DMETAL=ON ..
          xcodebuild -scheme Pcsx2 -configuration Release -arch arm64 -sdk iphoneos
          ```
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

